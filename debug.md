# 本地调试

## 原理
基于ffmpeg实现视频解码与截图，相关功能实现在[capture.c](./src/capture.c)文件，并通过Emscripten把ffmpeg和capture.c编译为js；最终生成文件为[web-capture.js](./dist/web-capture.js)，可以直接引用使用。

[asm.js 和 Emscripten 入门教程](https://www.ruanyifeng.com/blog/2017/09/asmjs_emscripten.html)

[emscripten安装](https://emscripten.org/docs/getting_started/downloads.html)

[FFMPEG开发快速入坑](https://zhuanlan.zhihu.com/p/345402619)

## 本地开发调试（Windows+WSL2）
主要环境：Windows10，并开启Linux子系统安装Ubuntu；VSCode安装在windows环境，并通过Remote - WSL扩展连接到Ubuntu子系统。
### 1.Windows环境 C/C++开发环境搭建
1. 安装VScode
2. 安装Remote - WSL扩展

3. 通过Remote - WSL扩展连接到Ubuntu子系统,并选择web-capture目录打开
   ![通过Remote - WSL](./pictures/vscode_remote.PNG)
4. 安装C/C++扩展
   ![C扩展](./pictures/vscode_c.PNG)

### 2. FFMPEG下载与编译
**以下操作在web-capture所在目录进行**
1. 下载 [ffmpeg-4.4.1.tar.xz](http://ffmpeg.org/releases/ffmpeg-4.4.1.tar.xz) 并解压至与 `web-capture` 同级的目录
   ```
   # web-capture 同级目录
   wget http://ffmpeg.org/releases/ffmpeg-4.4.1.tar.xz
   tar xvf ffmpeg-4.4.1.tar.xz
   ```
2. 编译ffmpeg
    ```
    sh ./web-capture/script/build_ffmpeg.sh
    ```

### 3. 开始调试
选中capture.c文件，并按F5按键开启调试，初次会生成launch.json和tasks.json文件
![Debug](./pictures/vscode_debug.PNG)

launch.json
```
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "gcc - Build and debug active file",
            "type": "cppdbg",
            "request": "launch",
            "program": "${fileDirname}/${fileBasenameNoExtension}",
            "args": [],
            "stopAtEntry": false,
            "cwd": "${fileDirname}",
            "environment": [],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "Enable pretty-printing for gdb",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                },
                {
                    "description": "Set Disassembly Flavor to Intel",
                    "text": "-gdb-set disassembly-flavor intel",
                    "ignoreFailures": true
                }
            ],
            "preLaunchTask": "C/C++: gcc build active file",
            "miDebuggerPath": "/usr/bin/gdb"
        }
    ]
}
```

tasks.json
```
{
    "tasks": [
        {
            "type": "cppbuild",
            "label": "C/C++: gcc build active file",
            "command": "/usr/bin/gcc",
            "args": [
                "-fdiagnostics-color=always",
                "-g",
                "${file}",
                "-L",
                "${workspaceFolder}/lib/ffmpeg4/lib",
                "-I",
                "${workspaceFolder}/lib/ffmpeg4/include",
                "-l",
                "avutil",
                "-l",
                "avformat",
                "-l",
                "avcodec",
                "-l",
                "avutil",
                "-l",
                "swscale",
                "-l",
                "m",
                "-l",
                "pthread",
                "-l",
                "swresample",
                "-l",
                "dl",
                "-o",
                "${fileDirname}/${fileBasenameNoExtension}"
            ],
            "options": {
                "cwd": "${fileDirname}"
            },
            "problemMatcher": [
                "$gcc"
            ],
            "group": {
                "kind": "build",
                "isDefault": true
            },
            "detail": "Task generated by Debugger."
        }
    ],
    "version": "2.0.0"
}
```


手动编译command
```
/usr/bin/gcc-9 -fdiagnostics-color=always -g /home/meng/repo/web-capture/src/capture.c -L/home/meng/repo/web-capture/lib/ffmpeg4/lib -I/home/meng/repo/web-capture/lib/ffmpeg4/include -lavutil -lavformat -lavcodec -lavutil -lswscale -lm -lpthread -lswresample -ldl -o /home/meng/repo/web-capture/src/capture
```

### 3. linux 系统常见错误
1. 执行 build.sh 报错 build.sh: : not found

    说明：Windows与Linux的回车换行转换
    最初"\r"（return）表示“回车”即回到行首，“\n”（next）表示“换行”即定位到下一行；UNIX和Linux使用“\n”换行，而Windows用“\r\n”(不是\n\r，已验证)，macOS用“\r”。

    Linux文本传到Windows一般少了一个换行；Windows传到Linux的文件，如果是一般文本文档显示正常可不用处理。（这是一般情况，也可能随编缉器的配置而出现别的情况）

    但如果是要用来执行的shell脚本，我们会看到显示完全正常语法再三检查也没问题但执行时就是提示“syntax error near unexpected token `do”等错误，这正是回车换行符的原因。
    [参考链接](https://www.cnblogs.com/lsdb/p/6781727.html)

    Windows-to-Linux:
    ```
    # .表示不是\n的任意其他字符，$表示行尾匹配；匹配行尾字符不是\n的行，将该字符删除，在我们的上下文中指删除\r
    sed -i 's/.$//' filename      
    ```
 
    Linux-to-Windows:

    ```
    # $表示行尾，整句意思是在行尾追加\r
    sed -i 's/$/\r/' filename　　
    ```
2. ubuntu系统下source: not found错误
    
    若在ubuntu系统下运行含有source命令的shell脚本时，出现source: not found错误，原因可能是shell的解释器不是bash，需把shell的解释器更改为bash。[参考链接](https://help.aliyun.com/document_detail/109503.html)
    
    请按以下步骤更改shell的解释器：

    1. 执行ls -l /bin/sh命令，若得到结果/bin/sh -> dash，则说明shell的解释器为dash。
    2. 执行dpkg-reconfigure dash命令，然后选择no。 **注意 此步骤需要root权限。**
    3. 再次执行ls -l /bin/sh命令，若得到结果/bin/sh -> bash，则说明成功更改shell的解释器为bash。